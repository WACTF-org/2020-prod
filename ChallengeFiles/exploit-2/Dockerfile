FROM golang as builder

COPY ./docker-files /app
RUN chmod +x /app/entry.sh

WORKDIR /app/kongserv

RUN CGO_ENABLED=0 go build -ldflags="-w -s" -o server ./

WORKDIR /app/clientserv

RUN CGO_ENABLED=0 go build -ldflags="-w -s" -o client ./


FROM alpine:latest

RUN apk add --no-cache bash

RUN addgroup -S mygroup && adduser --system --shell /bin/nologin --no-create-home -G mygroup --disabled-password myuser

USER myuser

COPY --from=builder --chown=myuser:mygroup /app/ /app/
ENV WACTF_FLAG="Reduce_Reuse_Recycle"
ENV WACTF_FLAG_SUFFIX="8e33ae46ef68409b2face55ac3bd651d"

EXPOSE 1337
EXPOSE 31337

ENTRYPOINT [ "/app/entry.sh" ]