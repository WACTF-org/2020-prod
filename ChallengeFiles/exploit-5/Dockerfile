FROM ubuntu:18.04

# Add low priv users
RUN adduser --system --shell /bin/false --disabled-login --disabled-password user
RUN adduser --system --no-create-home --shell /bin/false --disabled-login --disabled-password admin

# Install a couple tools
RUN apt update
RUN apt install coreutils -y
RUN apt install sudo -y
RUN apt install nmap -y
RUN rm -f `which nmap`

# Copy warez
COPY docker-files/serv /home/user/
COPY docker-files/wrapper /home/user/
COPY docker-files/flag /home/user/
RUN chmod 555 /home/user/serv
RUN chmod 555 /home/user/wrapper
RUN chmod 444 /home/user/flag

# Set up chroot
RUN echo "admin ALL = (ALL) NOPASSWD: /lolbin/chroot --userspec=user --groups= /home/user /wrapper" > /etc/sudoers.d/admin
RUN mkdir -p /home/user/lib64
RUN mkdir -p /home/user/usr/lib/x86_64-linux-gnu/
RUN mkdir -p /home/user/usr/lib/x86_64-linux-gnu/coreutils/
RUN mkdir -p /home/user/lib/x86_64-linux-gnu/
RUN mkdir -p /home/user/bin

# bins
RUN mv `which ncat` /home/user/
RUN mv `which stdbuf` /home/user/
RUN cp /bin/ls /home/user/bin/
RUN cp /bin/cat /home/user/bin/
RUN cp /bin/sh /home/user/bin/

# libs
RUN cp /usr/lib/x86_64-linux-gnu/libssl.so.1.1 /home/user/usr/lib/x86_64-linux-gnu/
RUN cp /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1 /home/user/usr/lib/x86_64-linux-gnu/
RUN cp /usr/lib/x86_64-linux-gnu/libpcap.so.0.8 /home/user/usr/lib/x86_64-linux-gnu/
RUN cp /usr/lib/x86_64-linux-gnu/liblua5.3.so.0 /home/user/usr/lib/x86_64-linux-gnu/
RUN cp /lib/x86_64-linux-gnu/libc.so.6 /home/user/lib/x86_64-linux-gnu/
RUN cp /lib/x86_64-linux-gnu/libpthread.so.0 /home/user/lib/x86_64-linux-gnu/
RUN cp /lib/x86_64-linux-gnu/libdl.so.2 /home/user/lib/x86_64-linux-gnu/
RUN cp /lib/x86_64-linux-gnu/libm.so.6 /home/user/lib/x86_64-linux-gnu/
RUN cp /lib64/ld-linux-x86-64.so.2 /home/user/lib64/
RUN cp /lib/x86_64-linux-gnu/libc.so.6 /home/user/lib/x86_64-linux-gnu/
RUN cp /lib64/ld-linux-x86-64.so.2 /home/user/lib/
RUN cp /usr/lib/x86_64-linux-gnu/coreutils/libstdbuf.so /home/user/usr/lib/x86_64-linux-gnu/coreutils/libstdbuf.so
RUN cp /lib/x86_64-linux-gnu/libselinux.so.1 /home/user/lib/x86_64-linux-gnu/libselinux.so.1
RUN cp /lib/x86_64-linux-gnu/libpcre.so.3 /home/user/lib/x86_64-linux-gnu/libpcre.so.3

# remove fs perms
RUN chmod -R o-w /home/user
RUN chmod o-w /home/user
RUN chown root /home/user

# just fuck my shit up
RUN mkdir /lolbin
RUN cp /bin/cp /lolbin/cp
RUN cp /usr/bin/sudo /lolbin/sudo
RUN chown root.root /lolbin/sudo
RUN chmod 7555 /lolbin/sudo
RUN cp `which chroot` /lolbin/chroot
RUN cp /bin/mkdir /lolbin/mkdir
RUN cp /bin/sh /lolbin/sh
RUN cp /bin/sleep /lolbin/sleep
RUN cp -r /usr/lib /lolbin/

# who needs this bs
RUN rm -rf /usr
RUN rm -rf /boot
RUN rm -rf /media
RUN rm -rf /mnt
RUN rm -rf /root
RUN rm -rf /run
RUN rm -rf /srv
RUN rm -rf /var
RUN rm -rf /opt
RUN rm -rf /sbin
RUN rm -rf /bin;/lolbin/mkdir /bin;/lolbin/cp /lolbin/sh /bin/sh

# restore the libs we deleted
RUN /lolbin/mkdir /usr
RUN /lolbin/cp -r /lolbin/lib /usr/

# drop privs
USER admin
CMD /lolbin/sudo /lolbin/chroot --userspec=user --groups= /home/user /wrapper