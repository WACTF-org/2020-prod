# Use alpine for its efficiency and small attack surface.
FROM alpine:latest

# Add a low priv user.
RUN adduser -S -s /bin/false -H -D user

# Install apache, php and sudo, make, java and javac
# This is needed to build the environment so it works with java inside the container
RUN apk add apache2 apache2-ctl php7-apache2 sudo openjdk8-jre openjdk8 make

# Set environment variavbles for openjdk
ENV JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk
ENV PATH="$JAVA_HOME/bin:${PATH}"

# Name the server
RUN echo "ServerName gamefinder" >> /etc/apache2/httpd.conf

# Whitelist the sudo command to allow user to run apache, but nothing else as root.
RUN echo "user ALL = (ALL) NOPASSWD: /usr/sbin/apachectl -D FOREGROUND" > /etc/sudoers.d/user

# Set the working directory.
WORKDIR /usr/src/gamefinder

# Copy the file from your host to your current location.
COPY . .

WORKDIR /usr/src/gamefinder/src

# Run the compile and install the gamefinder application.
RUN make install

WORKDIR /

RUN rm -rf /usr/src/gamefinder

# Run apache
CMD /usr/bin/sudo /usr/sbin/apachectl -D FOREGROUND

# Drop privs
USER user

# Your docker-compose should expose port 80
EXPOSE 80